# Codebase Audit & Development Plan

## üîç Audit of Phases 1-6 (Current Status)

Upon reviewing the codebase, I found that while the **file structure** partially mirrors the plan, the **core logic and functionality** for Phases 1-6 are largely incomplete or mocked.

| Phase | Status | Critical Gaps (Bugs/Missing Features) |
| :--- | :--- | :--- |
| **1. Modular Agent** | ‚ö†Ô∏è Partial | ‚Ä¢ `Agent` base class is missing; `CoderAgent` is standalone.<br>‚Ä¢ `ToolRegistry` is missing (tools are hardcoded).<br>‚Ä¢ Memory is ad-hoc (scans recent jobs) instead of DB-backed.<br>‚Ä¢ Debug tracing is missing. |
| **2. Team Support** | ‚ùå Missing | ‚Ä¢ `Team` class and delegation logic (Supervisor/Router) are missing.<br>‚Ä¢ `/server/routes/teams.ts` only returns static/mock data. |
| **3. Workflow Engine** | ‚ùå Missing | ‚Ä¢ No `Workflow` class or step definitions found.<br>‚Ä¢ No execution engine for sequential/parallel steps. |
| **4. Structured I/O** | ‚ö†Ô∏è Partial | ‚Ä¢ `zod` is present but not integrated into Agent execution for schema validation.<br>‚Ä¢ Multimodal support is not implemented in the runner. |
| **5. Knowledge** | ‚ùå Mocked | ‚Ä¢ `knowledge.ts` contains dummy routes that don't save data.<br>‚Ä¢ No vector database or embedding integration exists. |
| **6. Model Config** | ‚ö†Ô∏è Partial | ‚Ä¢ DB tables exist, but provider wrappers (OpenAI, Anthropic) and fallback logic are missing.<br>‚Ä¢ Validation logic is basic. |

---

## üõ†Ô∏è Remediation Plan (Fixing Phases 1-6)

Before proceeding to Phase 7, we **must** solidify the foundation.

1.  **Refactor Agent Framework**: Create `runner/src/agent_base.ts` and `runner/src/tools.ts` (Registry). Refactor `CoderAgent` to extend `Agent`.
2.  **Implement Team Core**: Create `runner/src/team.ts` with delegation logic.
3.  **Build Workflow Engine**: Create `runner/src/workflow.ts` for step execution.
4.  **Real Knowledge Base**: Replace mock `knowledge.ts` with actual SQLite-VSS or simple vector storage.
5.  **Model Providers**: Implement `server/src/llm/` with proper provider adapters.

---

## üöÄ Development Plan: Phases 7-10

Once the foundation is fixed, we will proceed with the following phases:

### Phase 7: Session & State Enhancements
**Goal**: Persistent, manageable, and intelligent session handling.
*   **Session Naming**: Auto-generate names using LLM summarization of the first turn.
*   **Caching**: Implement memory caching for active sessions to reduce DB hits.
*   **History Patterns**: Add `history_mode` (ALWAYS, ON_DEMAND, MANUAL) to Agent config.
*   **State API**: Expose endpoints to read/write `session_state` externally.

### Phase 8: Context Compression & Guardrails
**Goal**: Cost efficiency and safety.
*   **CompressionManager**: Implement a service that summarizes conversation history when token limits are approached.
*   **Guardrails**: Add a middleware layer to check inputs/outputs against safety policies (regex or model-based).

### Phase 9: Hooks, Human-in-the-Loop & Cancellation
**Goal**: Control and extensibility.
*   **Hooks System**: Add `EventEmitter` hooks (`beforePrompt`, `afterToolCall`) in `Agent` class.
*   **Approval Flow**: Add `requires_approval` flag to Tools. Pause execution and wait for user API signal.
*   **Cancellation**: Pass `AbortSignal` through the runner to allow terminating long-running agents.

### Phase 10: Advanced Capabilities
**Goal**: Production-grade features.
*   **Skills**: Create a `Skill` class (bundle of tools + prompts).
*   **Reasoning**: Implement `ReAct` and `Chain-of-Thought` wrappers.
*   **Tracing**: Integrate OpenTelemetry for full observability.
*   **Evals**: Build a simple evaluation harness for agent performance.

---

## üìÖ Immediate Next Step
I recommend we start by **fixing the Agent Framework (Phase 1)** and **implementing the Tool Registry**, as everything else depends on this.

**Shall I begin with the Phase 1 remediation?**