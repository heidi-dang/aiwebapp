name: CI

on:
  push:
    branches: [ main, ollama-integration ]
  pull_request:
    branches: [ main, ollama-integration ]

jobs:
  repo-hygiene:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for secrets
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for forbidden files
        run: |
          forbidden_files=".env .local .private *.log build/ dist/"
          for file in $forbidden_files; do
            if find . -name "$file" -type f | grep -q .; then
              echo "Forbidden file found: $file"
              exit 1
            fi
          done

  config-validation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate configuration
        run: |
          # Check required env vars in .env.example files
          required_vars="MAX_ITERATIONS REQUEST_TIMEOUT_MS MAX_PAYLOAD_SIZE FEATURE_X_ENABLED"
          for var in $required_vars; do
            if ! grep -q "^$var=" */.env.example 2>/dev/null; then
              echo "Missing required env var: $var"
              exit 1
            fi
          done

  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

  build:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  runtime-sanity:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Check for infinite loops
        run: node scripts/check-safety.js

      - name: Start and stop app
        run: |
          timeout 30s npm run dev &
          sleep 10
          pkill -f "npm run dev" || true
          sleep 5
          if pgrep -f "npm run dev" > /dev/null; then
            echo "App did not shut down cleanly"
            exit 1
          fi

  log-discipline:
    runs-on: ubuntu-latest
    needs: runtime-sanity
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check log files
        run: |
          if find . -name "*.log" -type f -size +1M | grep -q .; then
            echo "Log files exceed 1MB"
            exit 1
          fi
          if grep -r "password\|secret\|token" logs/ 2>/dev/null; then
            echo "Sensitive data in logs"
            exit 1
          fi